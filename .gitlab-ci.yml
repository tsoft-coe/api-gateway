stages:
  - build
  - test
  - package
  - deploy-dev
  - deploy-qa
  - deploy-prd

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

before_script:
  - echo "Pipeline started for $CI_PROJECT_NAME"

# Build stage
build:
  stage: build
  image: node:20-alpine
  script:
    - echo "Installing dependencies..."
    - npm ci --prefer-offline --no-audit
    - echo "Build completed successfully"
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - main
    - develop
    - merge_requests

# Test stage
test:
  stage: test
  image: node:20-alpine
  dependencies:
    - build
  script:
    - echo "Running tests..."
    - npm run test || echo "No tests configured"
  only:
    - main
    - develop
    - merge_requests

# Package stage - Build Docker image
package:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "Logging into Docker registry..."
    - echo "$DOCKER_REGISTRY_PASSWORD" | docker login -u "$DOCKER_REGISTRY_USER" --password-stdin $DOCKER_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
    - echo "Pushing image to registry..."
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
    - echo "Image pushed: $IMAGE_TAG"
  only:
    - main
    - develop

# Deploy to DEV
deploy-dev:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_DEV" > ~/.kube/config
    - kubectl config use-context kind-dev
  script:
    - echo "Deploying to DEV environment..."
    - kubectl create namespace $KUBE_NAMESPACE_DEV --dry-run=client -o yaml | kubectl apply -f -
    - |
      cat <<EOF | kubectl apply -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: $CI_PROJECT_NAME
        namespace: $KUBE_NAMESPACE_DEV
        labels:
          app: $CI_PROJECT_NAME
          environment: dev
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: $CI_PROJECT_NAME
        template:
          metadata:
            labels:
              app: $CI_PROJECT_NAME
              environment: dev
          spec:
            containers:
            - name: $CI_PROJECT_NAME
              image: $IMAGE_TAG
              ports:
              - containerPort: 3000
              env:
              - name: NODE_ENV
                value: "development"
              - name: KEYCLOAK_URL
                value: "$KEYCLOAK_URL"
              - name: KEYCLOAK_REALM
                value: "$KEYCLOAK_REALM"
              - name: PORT
                value: "3000"
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 200m
                  memory: 256Mi
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: $CI_PROJECT_NAME
        namespace: $KUBE_NAMESPACE_DEV
        labels:
          app: $CI_PROJECT_NAME
      spec:
        type: ClusterIP
        ports:
        - port: 80
          targetPort: 3000
          protocol: TCP
        selector:
          app: $CI_PROJECT_NAME
      EOF
    - kubectl rollout status deployment/$CI_PROJECT_NAME -n $KUBE_NAMESPACE_DEV
    - echo "Deployment to DEV completed successfully"
  environment:
    name: development
    url: http://$CI_PROJECT_NAME.dev.bankapp.local
  only:
    - main

# Deploy to QA (manual)
deploy-qa:
  stage: deploy-qa
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_QA" > ~/.kube/config
    - kubectl config use-context kind-qa
  script:
    - echo "Deploying to QA environment..."
    - kubectl create namespace $KUBE_NAMESPACE_QA --dry-run=client -o yaml | kubectl apply -f -
    - |
      cat <<EOF | kubectl apply -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: $CI_PROJECT_NAME
        namespace: $KUBE_NAMESPACE_QA
        labels:
          app: $CI_PROJECT_NAME
          environment: qa
      spec:
        replicas: 2
        selector:
          matchLabels:
            app: $CI_PROJECT_NAME
        template:
          metadata:
            labels:
              app: $CI_PROJECT_NAME
              environment: qa
          spec:
            containers:
            - name: $CI_PROJECT_NAME
              image: $IMAGE_TAG
              ports:
              - containerPort: 3000
              env:
              - name: NODE_ENV
                value: "production"
              - name: KEYCLOAK_URL
                value: "$KEYCLOAK_URL"
              - name: KEYCLOAK_REALM
                value: "$KEYCLOAK_REALM"
              - name: PORT
                value: "3000"
              resources:
                requests:
                  cpu: 200m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: $CI_PROJECT_NAME
        namespace: $KUBE_NAMESPACE_QA
        labels:
          app: $CI_PROJECT_NAME
      spec:
        type: ClusterIP
        ports:
        - port: 80
          targetPort: 3000
          protocol: TCP
        selector:
          app: $CI_PROJECT_NAME
      EOF
    - kubectl rollout status deployment/$CI_PROJECT_NAME -n $KUBE_NAMESPACE_QA
    - echo "Deployment to QA completed successfully"
  environment:
    name: qa
    url: http://$CI_PROJECT_NAME.qa.bankapp.local
  when: manual
  only:
    - main

# Deploy to PRD (manual, protected)
deploy-prd:
  stage: deploy-prd
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_PRD" > ~/.kube/config
    - kubectl config use-context kind-prd
  script:
    - echo "Deploying to PRODUCTION environment..."
    - kubectl create namespace $KUBE_NAMESPACE_PRD --dry-run=client -o yaml | kubectl apply -f -
    - |
      cat <<EOF | kubectl apply -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: $CI_PROJECT_NAME
        namespace: $KUBE_NAMESPACE_PRD
        labels:
          app: $CI_PROJECT_NAME
          environment: prd
      spec:
        replicas: 3
        selector:
          matchLabels:
            app: $CI_PROJECT_NAME
        template:
          metadata:
            labels:
              app: $CI_PROJECT_NAME
              environment: prd
          spec:
            containers:
            - name: $CI_PROJECT_NAME
              image: $IMAGE_TAG
              ports:
              - containerPort: 3000
              env:
              - name: NODE_ENV
                value: "production"
              - name: KEYCLOAK_URL
                value: "$KEYCLOAK_URL"
              - name: KEYCLOAK_REALM
                value: "$KEYCLOAK_REALM"
              - name: PORT
                value: "3000"
              resources:
                requests:
                  cpu: 500m
                  memory: 512Mi
                limits:
                  cpu: 1000m
                  memory: 1Gi
              livenessProbe:
                httpGet:
                  path: /health
                  port: 3000
                initialDelaySeconds: 30
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /ready
                  port: 3000
                initialDelaySeconds: 5
                periodSeconds: 5
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: $CI_PROJECT_NAME
        namespace: $KUBE_NAMESPACE_PRD
        labels:
          app: $CI_PROJECT_NAME
      spec:
        type: ClusterIP
        ports:
        - port: 80
          targetPort: 3000
          protocol: TCP
        selector:
          app: $CI_PROJECT_NAME
      EOF
    - kubectl rollout status deployment/$CI_PROJECT_NAME -n $KUBE_NAMESPACE_PRD
    - echo "Deployment to PRODUCTION completed successfully"
  environment:
    name: production
    url: http://$CI_PROJECT_NAME.prd.bankapp.local
  when: manual
  only:
    - main
