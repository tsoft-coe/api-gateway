variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  NODE_VERSION: "22-alpine"

  # GitLab Registry
  SERVICE_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_PATH}"

stages:
  - lint
  - test
  - build
  - security

# ==============================================
# STAGE 1: LINT & CODE QUALITY
# ==============================================
lint:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run lint || echo "No lint script found, skipping..."
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - branches
    - merge_requests

# ==============================================
# STAGE 2: UNIT & INTEGRATION TESTS
# ==============================================
test:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    POSTGRES_DB: bankapp_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: bankapp_test
    DB_USER: test
    DB_PASSWORD: test
    REDIS_HOST: redis
    REDIS_PORT: 6379
  script:
    - npm ci
    - npm test -- --coverage || echo "No tests found, skipping..."
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    paths:
      - coverage/
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - branches
    - merge_requests

# ==============================================
# STAGE 3: BUILD & PUSH DOCKER IMAGES (BuildKit Rootless)
# ==============================================
build:
  stage: build
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  variables:
    BUILDKITD_FLAGS: --oci-worker-no-process-sandbox
  before_script:
    # Create Docker auth config for BuildKit rootless
    - mkdir -p ~/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "$CI_REGISTRY_USER" "$CI_REGISTRY_PASSWORD" | base64 | tr -d '\n')\"}}}" > ~/.docker/config.json
    # Configure BuildKit to allow HTTP registry (insecure for development)
    - |
      cat > /tmp/buildkitd.toml <<EOF
      [registry."gitlab.bankapp.local:5050"]
        http = true
        insecure = true
      EOF
  script:
    # Build and push with commit SHA tag (with cache)
    - |
      buildctl-daemonless.sh \
        --config=/tmp/buildkitd.toml \
        build \
        --frontend=dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        --output type=image,name=$SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA,push=true,registry.insecure=true \
        --export-cache type=registry,ref=$SERVICE_IMAGE:buildcache,registry.insecure=true \
        --import-cache type=registry,ref=$SERVICE_IMAGE:buildcache,registry.insecure=true
    # Build and push latest tag (reusing cache)
    - |
      buildctl-daemonless.sh \
        --config=/tmp/buildkitd.toml \
        build \
        --frontend=dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        --output type=image,name=$SERVICE_IMAGE:latest,push=true,registry.insecure=true \
        --import-cache type=registry,ref=$SERVICE_IMAGE:buildcache,registry.insecure=true
  only:
    - main
    - develop
    - tags

# ==============================================
# STAGE 4: SECURITY SCANNING
# ==============================================
security:dependency-scan:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - echo "Scanning dependencies for vulnerabilities..."
    - npm ci
    - npm audit --audit-level=moderate || true
  allow_failure: true
  only:
    - branches
    - merge_requests

security:container-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --severity HIGH,CRITICAL --exit-code 0 $SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA || true
  allow_failure: true
  only:
    - main
    - develop
  needs:
    - build
