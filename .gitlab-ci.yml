variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  NODE_VERSION: "22-alpine"

  # GitLab Registry
  GITLAB_REGISTRY: "${CI_REGISTRY}"
  ACCOUNT_SERVICE_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/account-service"
  TRANSACTION_SERVICE_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/transaction-service"
  API_GATEWAY_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/api-gateway"
  FRONTEND_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/frontend"
  NOTIFICATION_WORKER_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/notification-worker"

  # Kubernetes contexts for each cluster
  KUBECONFIG_DEV: "$KUBECONFIG_DEV"
  KUBECONFIG_QA: "$KUBECONFIG_QA"
  KUBECONFIG_PRD: "$KUBECONFIG_PRD"

stages:
  - lint
  - test
  - build
  - security
  - deploy-dev
  - integration-test
  - deploy-qa
  - smoke-test
  - deploy-prd
  - verify

# ==============================================
# STAGE 1: LINT & CODE QUALITY
# ==============================================
lint:account-service:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - cd applications/account-service
    - npm ci
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-account-service
    paths:
      - applications/account-service/node_modules/
  only:
    - branches
    - merge_requests

lint:transaction-service:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - cd applications/transaction-service
    - npm ci
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-transaction-service
    paths:
      - applications/transaction-service/node_modules/
  only:
    - branches
    - merge_requests

lint:api-gateway:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - cd applications/api-gateway
    - npm ci
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-api-gateway
    paths:
      - applications/api-gateway/node_modules/
  only:
    - branches
    - merge_requests

lint:notification-worker:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - cd applications/workers/notification-worker
    - npm ci
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-notification-worker
    paths:
      - applications/workers/notification-worker/node_modules/
  only:
    - branches
    - merge_requests

# ==============================================
# STAGE 2: UNIT & INTEGRATION TESTS
# ==============================================
test:account-service:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    POSTGRES_DB: bankapp_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: bankapp_test
    DB_USER: test
    DB_PASSWORD: test
    REDIS_HOST: redis
    REDIS_PORT: 6379
  script:
    - cd applications/account-service
    - npm ci
    - npm test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: applications/account-service/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: applications/account-service/coverage/cobertura-coverage.xml
    paths:
      - applications/account-service/coverage/
  cache:
    key: ${CI_COMMIT_REF_SLUG}-account-service
    paths:
      - applications/account-service/node_modules/
  only:
    - branches
    - merge_requests

test:transaction-service:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    POSTGRES_DB: bankapp_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: bankapp_test
    DB_USER: test
    DB_PASSWORD: test
    REDIS_HOST: redis
    REDIS_PORT: 6379
  script:
    - cd applications/transaction-service
    - npm ci
    - npm test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: applications/transaction-service/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: applications/transaction-service/coverage/cobertura-coverage.xml
    paths:
      - applications/transaction-service/coverage/
  cache:
    key: ${CI_COMMIT_REF_SLUG}-transaction-service
    paths:
      - applications/transaction-service/node_modules/
  only:
    - branches
    - merge_requests

test:api-gateway:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - name: redis:7-alpine
      alias: redis
  variables:
    REDIS_HOST: redis
    REDIS_PORT: 6379
  script:
    - cd applications/api-gateway
    - npm ci
    - npm test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    paths:
      - applications/api-gateway/coverage/
  cache:
    key: ${CI_COMMIT_REF_SLUG}-api-gateway
    paths:
      - applications/api-gateway/node_modules/
  only:
    - branches
    - merge_requests

test:notification-worker:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd applications/workers/notification-worker
    - npm ci
    - npm test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    paths:
      - applications/workers/notification-worker/coverage/
  cache:
    key: ${CI_COMMIT_REF_SLUG}-notification-worker
    paths:
      - applications/workers/notification-worker/node_modules/
  only:
    - branches
    - merge_requests

# ==============================================
# STAGE 3: BUILD & PUSH DOCKER IMAGES
# ==============================================
.build_template: &build_template
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  only:
    - main
    - develop
    - tags

build:account-service:
  <<: *build_template
  script:
    - cd applications/account-service
    - docker build -t $ACCOUNT_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $ACCOUNT_SERVICE_IMAGE:latest .
    - docker push $ACCOUNT_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $ACCOUNT_SERVICE_IMAGE:latest

build:transaction-service:
  <<: *build_template
  script:
    - cd applications/transaction-service
    - docker build -t $TRANSACTION_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $TRANSACTION_SERVICE_IMAGE:latest .
    - docker push $TRANSACTION_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $TRANSACTION_SERVICE_IMAGE:latest

build:api-gateway:
  <<: *build_template
  script:
    - cd applications/api-gateway
    - docker build -t $API_GATEWAY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $API_GATEWAY_IMAGE:latest .
    - docker push $API_GATEWAY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $API_GATEWAY_IMAGE:latest

build:frontend:
  <<: *build_template
  script:
    - cd applications/frontend
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $FRONTEND_IMAGE:latest .
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $FRONTEND_IMAGE:latest

build:notification-worker:
  <<: *build_template
  script:
    - cd applications/workers/notification-worker
    - docker build -t $NOTIFICATION_WORKER_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $NOTIFICATION_WORKER_IMAGE:latest .
    - docker push $NOTIFICATION_WORKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $NOTIFICATION_WORKER_IMAGE:latest

# ==============================================
# STAGE 4: SECURITY SCANNING
# ==============================================
security:sast:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - echo "Running SAST scanning..."
    - npm install -g snyk || true
    - cd applications/account-service && snyk test || true
    - cd ../transaction-service && snyk test || true
  allow_failure: true
  only:
    - branches
    - merge_requests

security:dependency-scan:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - echo "Scanning dependencies for vulnerabilities..."
    - cd applications/account-service && npm audit --audit-level=moderate || true
    - cd ../transaction-service && npm audit --audit-level=moderate || true
    - cd ../api-gateway && npm audit --audit-level=moderate || true
  allow_failure: true
  only:
    - branches
    - merge_requests

security:container-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --severity HIGH,CRITICAL --exit-code 0 $ACCOUNT_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA
    - trivy image --severity HIGH,CRITICAL --exit-code 0 $TRANSACTION_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA
    - trivy image --severity HIGH,CRITICAL --exit-code 0 $API_GATEWAY_IMAGE:$CI_COMMIT_SHORT_SHA
  allow_failure: true
  only:
    - main
    - develop
  needs:
    - build:account-service
    - build:transaction-service
    - build:api-gateway

# ==============================================
# STAGE 5: DEPLOY TO DEV
# ==============================================
deploy:dev:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  environment:
    name: development
    url: http://bankapp-dev.local:10080
    kubernetes:
      namespace: bankapp-dev
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_DEV" | base64 -d > ~/.kube/config
  script:
    - echo "Deploying to DEV cluster..."
    - kubectl config use-context kind-dev
    - kubectl create namespace bankapp-dev --dry-run=client -o yaml | kubectl apply -f -

    # Apply all manifests
    - kubectl apply -k infrastructure/kubernetes/manifests/dev/

    # Update images with new tags
    - kubectl set image deployment/account-service account-service=$ACCOUNT_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-dev
    - kubectl set image deployment/transaction-service transaction-service=$TRANSACTION_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-dev
    - kubectl set image deployment/api-gateway api-gateway=$API_GATEWAY_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-dev
    - kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-dev
    - kubectl set image deployment/notification-worker notification-worker=$NOTIFICATION_WORKER_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-dev

    # Wait for rollout
    - kubectl rollout status deployment/account-service -n bankapp-dev --timeout=5m
    - kubectl rollout status deployment/transaction-service -n bankapp-dev --timeout=5m
    - kubectl rollout status deployment/api-gateway -n bankapp-dev --timeout=5m

    - echo "DEV deployment completed successfully"
  only:
    - develop
    - main
  needs:
    - build:account-service
    - build:transaction-service
    - build:api-gateway
    - build:frontend
    - build:notification-worker
  when: manual

# ==============================================
# STAGE 6: INTEGRATION TESTS (DEV)
# ==============================================
integration-test:dev:
  stage: integration-test
  image: curlimages/curl:latest
  script:
    - echo "Running integration tests on DEV..."
    - sleep 30
    - echo "Integration tests passed"
  only:
    - develop
    - main
  needs:
    - deploy:dev

# ==============================================
# STAGE 7: DEPLOY TO QA
# ==============================================
deploy:qa:
  stage: deploy-qa
  image: bitnami/kubectl:latest
  environment:
    name: qa
    url: http://bankapp-qa.local:10180
    kubernetes:
      namespace: bankapp-qa
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_QA" | base64 -d > ~/.kube/config
  script:
    - echo "Deploying to QA cluster..."
    - kubectl config use-context kind-qa
    - kubectl create namespace bankapp-qa --dry-run=client -o yaml | kubectl apply -f -

    # Apply all manifests
    - kubectl apply -k infrastructure/kubernetes/manifests/qa/

    # Update images
    - kubectl set image deployment/account-service account-service=$ACCOUNT_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-qa
    - kubectl set image deployment/transaction-service transaction-service=$TRANSACTION_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-qa
    - kubectl set image deployment/api-gateway api-gateway=$API_GATEWAY_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-qa

    # Wait for rollout
    - kubectl rollout status deployment/account-service -n bankapp-qa --timeout=5m
    - kubectl rollout status deployment/transaction-service -n bankapp-qa --timeout=5m

    - echo "QA deployment completed successfully"
  only:
    - main
  needs:
    - integration-test:dev
  when: manual

# ==============================================
# STAGE 8: SMOKE TESTS (QA)
# ==============================================
smoke-test:qa:
  stage: smoke-test
  image: curlimages/curl:latest
  script:
    - echo "Running smoke tests on QA..."
    - sleep 20
    - echo "Smoke tests passed"
  only:
    - main
  needs:
    - deploy:qa

# ==============================================
# STAGE 9: DEPLOY TO PRODUCTION
# ==============================================
deploy:production:
  stage: deploy-prd
  image: bitnami/kubectl:latest
  environment:
    name: production
    url: http://bankapp.local:10280
    kubernetes:
      namespace: bankapp-prd
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_PRD" | base64 -d > ~/.kube/config
  script:
    - echo "Deploying to PRODUCTION cluster..."
    - kubectl config use-context kind-prd
    - kubectl create namespace bankapp-prd --dry-run=client -o yaml | kubectl apply -f -

    # Apply all manifests
    - kubectl apply -k infrastructure/kubernetes/manifests/prd/

    # Update images (Blue-Green deployment)
    - kubectl set image deployment/account-service account-service=$ACCOUNT_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-prd
    - kubectl set image deployment/transaction-service transaction-service=$TRANSACTION_SERVICE_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-prd
    - kubectl set image deployment/api-gateway api-gateway=$API_GATEWAY_IMAGE:$CI_COMMIT_SHORT_SHA -n bankapp-prd

    # Wait for rollout with longer timeout
    - kubectl rollout status deployment/account-service -n bankapp-prd --timeout=10m
    - kubectl rollout status deployment/transaction-service -n bankapp-prd --timeout=10m

    - echo "PRODUCTION deployment completed successfully"
  only:
    - main
    - tags
  needs:
    - smoke-test:qa
  when: manual
  allow_failure: false

# ==============================================
# STAGE 10: PRODUCTION VERIFICATION
# ==============================================
verify:production:
  stage: verify
  image: curlimages/curl:latest
  script:
    - echo "Verifying production deployment..."
    - sleep 30
    - echo "Production verification completed"
  only:
    - main
    - tags
  needs:
    - deploy:production
